name: Enviar Palabra del D√≠a

on:
  schedule:
    - cron: '0 7 * * *'  # Todos los d√≠as a las 7:00 UTC ‚Üí 4:00 Argentina
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Warm-up del backend
        run: |
          echo "üî• Calentando backend para evitar cold start..."
          WARMUP_RESPONSE=$(curl -s -w "\n%{http_code}" \
            "https://nuevo-palabra-del-dia-backend.vercel.app/api/send-notification?type=daily" \
            --connect-timeout 30 \
            --max-time 45)
          
          WARMUP_HTTP_CODE=$(echo "$WARMUP_RESPONSE" | tail -n1)
          echo "üì° Status del warm-up: $WARMUP_HTTP_CODE"
          
          if [ "$WARMUP_HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Warm-up exitoso"
          else
            echo "‚ö†Ô∏è Warm-up no √≥ptimo, pero continuando..."
          fi
          
          echo "‚è≥ Esperando 15 segundos antes del request real..."
          sleep 15

      - name: Enviar palabra del d√≠a con reintentos robustos
        run: |
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "üîî Intento $((RETRY_COUNT + 1)) de $MAX_RETRIES para enviar notificaci√≥n diaria..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
              "https://nuevo-palabra-del-dia-backend.vercel.app/api/send-notification?type=daily" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Actions-Palabra-Diaria/1.0" \
              --connect-timeout 60 \
              --max-time 120 \
              --retry 2 \
              --retry-delay 10 \
              --retry-max-time 300)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
            
            echo "üì° C√≥digo HTTP: $HTTP_CODE"
            echo "üì¶ Respuesta del servidor: $RESPONSE_BODY"
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ Notificaci√≥n diaria enviada exitosamente en el intento $((RETRY_COUNT + 1))"
              echo "üìã Detalles: $RESPONSE_BODY"
              SUCCESS=true
            else
              echo "‚ùå Error en el intento $((RETRY_COUNT + 1)) - HTTP: $HTTP_CODE"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                RETRY_DELAY=$((30 * RETRY_COUNT))
                echo "‚è≥ Esperando $RETRY_DELAY segundos antes del pr√≥ximo intento..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          if [ "$SUCCESS" = "false" ]; then
            echo "üí• Todos los $MAX_RETRIES intentos fallaron"
            echo "üö® La notificaci√≥n de la palabra del d√≠a NO se envi√≥"
            exit 1
          fi
        timeout-minutes: 5

      - name: Notificar √©xito
        if: success()
        run: |
          echo "üéâ Notificaci√≥n de la palabra del d√≠a enviada correctamente"
          echo "üìñ Los usuarios recibir√°n su devocional diario"
          echo "üïê Timestamp: $(date -u)"
          echo "‚úÖ Proceso completado exitosamente"

      - name: Debug en caso de falla
        if: failure()
        run: |
          echo "üîç Informaci√≥n de debug para diagn√≥stico:"
          echo "=========================================="
          echo "URL del endpoint: https://nuevo-palabra-del-dia-backend.vercel.app/api/send-notification?type=daily"
          echo "Hora del error: $(date -u)"
          echo "Tipo de notificaci√≥n: daily"
          echo "√öltimo estado del servicio:"
          
          # Verificar conectividad b√°sica
          echo "üì° Verificando conectividad..."
          ping -c 3 nuevo-palabra-del-dia-backend.vercel.app || echo "‚ùå No se pudo hacer ping"
          
          echo "üîó Verificando respuesta HTTP..."
          curl -I -X GET \
            "https://nuevo-palabra-del-dia-backend.vercel.app/api/send-notification?type=daily" \
            --connect-timeout 10 \
            --max-time 15 || echo "‚ùå No se pudo conectar al endpoint"
          
          echo "=========================================="
          echo "‚ö†Ô∏è Posibles causas:"
          echo "   - Cold start del servidor en Vercel"
          echo "   - Timeout en la respuesta"
          echo "   - Error interno del backend"
          echo "   - Problemas de red temporales"
          echo "   - Configuraci√≥n incorrecta del topic 'daily'"

      - name: Notificar fallo completo
        if: failure()
        run: |
          echo "üö® FALLO CR√çTICO: El env√≠o autom√°tico de la palabra del d√≠a fall√≥"
          echo "üïê Hora: $(date -u)"
          echo "üìñ Los usuarios NO recibir√°n su devocional diario"
          echo "üîß Se requiere intervenci√≥n manual para investigar los logs"
          echo "üìã Revisar:"
          echo "   - Logs de Vercel"
          echo "   - Estado del servicio"
          echo "   - Configuraci√≥n de variables de entorno"
          echo "   - Topic 'daily' en Firebase"
