name: Enviar Palabra del D√≠a

on:
  schedule:
    - cron: '0 7 * * *'  # Todos los d√≠as a las 7:00 UTC ‚Üí 4:00 Argentina
  workflow_dispatch:      # Permite ejecuci√≥n manual

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Verificar estado del servicio
        run: |
          echo "üîç Verificando estado del backend antes de enviar..."
          HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://nuevo-palabra-del-dia-backend.vercel.app/api/send-notification?type=daily" \
            --connect-timeout 10)
          
          echo "üìä Status del health check: $HEALTH_CHECK"
          
          if [ "$HEALTH_CHECK" -eq 200 ]; then
            echo "‚úÖ Servicio respondiendo correctamente"
          else
            echo "‚ö†Ô∏è Servicio puede estar en cold start"
          fi

      - name: Warm-up del backend
        run: |
          echo "üî• Calentando backend para evitar cold start..."
          curl -s "https://nuevo-palabra-del-dia-backend.vercel.app/api/send-notification?type=daily" \
            --connect-timeout 30 \
            --max-time 45 > /dev/null 2>&1 &
          
          echo "‚è≥ Esperando 20 segundos para cold start..."
          sleep 20

      - name: Enviar notificaci√≥n diaria
        run: |
          echo "üîî Enviando notificaci√≥n diaria..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
            "https://nuevo-palabra-del-dia-backend.vercel.app/api/send-notification?type=daily" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Daily/1.0" \
            --connect-timeout 60 \
            --max-time 120)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "üì° C√≥digo HTTP: $HTTP_CODE"
          echo "üì¶ Respuesta completa: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ NOTIFICACI√ìN ENVIADA EXITOSAMENTE"
            echo "üìñ Los usuarios recibir√°n: Palabra del D√≠a"
            echo "üéØ Topic: daily"
            echo "üïê Timestamp: $(date -u)"
          else
            echo "‚ùå ERROR: C√≥digo HTTP $HTTP_CODE"
            echo "üí• Respuesta del servidor: $RESPONSE_BODY"
            exit 1
          fi
        timeout-minutes: 5
